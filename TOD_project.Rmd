---
title: "TOD Assignment"
author: "Anna Duan, Bingchu Chen"
date: "9/20/2020"
output: 
    html_document: 
        code_folding: hide
#revisit to add table of contents, hide code chunks, etc
---
## Introduction

Transit Oriented Development (TOD) is a transportation planning concept which promotes
developing communities around public transportation. This is believed to improve the 
quality of life of residents and generate business, while increasing land value
and making transit systems more efficient. In recent years, a number of cities have invested in TOD, including Boston, Massachusetts. Boston, Massachusetts has one of the 
most developed public transportation systems in the country, with the Massachusetts Bay
Transportation Authority operating subway, trolley, bus, and boat services within the
Greater Boston area. In the past decade, [MBTA] (https://www.mbtarealty.com/transit-oriented-development/) has worked with private developers and the city to support more than 50 TOD projects near its stations. 

This makes Boston an interesting case for studying the effects of TOD. In this 
  brief, we analyze the relationship between TOD and neighborhood value. 
 
```{r Set Up, message=FALSE, warning=FALSE, include=TRUE}
knitr::opts_chunk$set



# LIBRARIES
#install.packages("tidyverse")          
library(tidyverse)
#install.packages("tidycensus")
library(tidycensus)
library(sf)
library(kableExtra)

options(scipen=999)
options(tigris_class = "sf")




# DEFINE MULTIPLE RING BUFFER FUNCTION
multipleRingBuffer <- function(inputPolygon, maxDistance, interval) 
{
  #create a list of distances that we'll iterate through to create each ring
  distances <- seq(0, maxDistance, interval)
  #we'll start with the second value in that list - the first is '0'
  distancesCounter <- 2
  #total number of rings we're going to create
  numberOfRings <- floor(maxDistance / interval)
  #a counter of number of rings
  numberOfRingsCounter <- 1
  #initialize an otuput data frame (that is not an sf)
  allRings <- data.frame()
  
  #while number of rings  counteris less than the specified nubmer of rings
  while (numberOfRingsCounter <= numberOfRings) 
  {
    #if we're interested in a negative buffer and this is the first buffer
    #(ie. not distance = '0' in the distances list)
    if(distances[distancesCounter] < 0 & distancesCounter == 2)
    {
      #buffer the input by the first distance
      buffer1 <- st_buffer(inputPolygon, distances[distancesCounter])
      #different that buffer from the input polygon to get the first ring
      buffer1_ <- st_difference(inputPolygon, buffer1)
      #cast this sf as a polygon geometry type
      thisRing <- st_cast(buffer1_, "POLYGON")
      #take the last column which is 'geometry'
      thisRing <- as.data.frame(thisRing[,ncol(thisRing)])
      #add a new field, 'distance' so we know how far the distance is for a give ring
      thisRing$distance <- distances[distancesCounter]
    }
    
    #otherwise, if this is the second or more ring (and a negative buffer)
    else if(distances[distancesCounter] < 0 & distancesCounter > 2) 
    {
      #buffer by a specific distance
      buffer1 <- st_buffer(inputPolygon, distances[distancesCounter])
      #create the next smallest buffer
      buffer2 <- st_buffer(inputPolygon, distances[distancesCounter-1])
      #This can then be used to difference out a buffer running from 660 to 1320
      #This works because differencing 1320ft by 660ft = a buffer between 660 & 1320.
      #bc the area after 660ft in buffer2 = NA.
      thisRing <- st_difference(buffer2,buffer1)
      #cast as apolygon
      thisRing <- st_cast(thisRing, "POLYGON")
      #get the last field
      thisRing <- as.data.frame(thisRing$geometry)
      #create the distance field
      thisRing$distance <- distances[distancesCounter]
    }
  
    #Otherwise, if its a positive buffer
    else 
    {
      #Create a positive buffer
      buffer1 <- st_buffer(inputPolygon, distances[distancesCounter])
      #create a positive buffer that is one distance smaller. So if its the first buffer
      #distance, buffer1_ will = 0. 
      buffer1_ <- st_buffer(inputPolygon, distances[distancesCounter-1])
      #difference the two buffers
      thisRing <- st_difference(buffer1,buffer1_)
      #cast as a polygon
      thisRing <- st_cast(thisRing, "POLYGON")
      #geometry column as a data frame
      thisRing <- as.data.frame(thisRing[,ncol(thisRing)])
      #add the distance
      thisRing$distance <- distances[distancesCounter]
    }  
    
    #rbind this ring to the rest of the rings
    allRings <- rbind(allRings, thisRing)
    #iterate the distance counter
    distancesCounter <- distancesCounter + 1
    #iterate the number of rings counter
    numberOfRingsCounter <- numberOfRingsCounter + 1
  }
  #convert the allRings data frame to an sf data frame
  allRings <- st_as_sf(allRings)
}

#Plot Formatting
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.text.x = element_text(size = 10))
}
plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 10,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=10),
    axis.title = element_text(size=10),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 10)
  )
}
# Quintile Map Breaks
qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                 c(.01,.2,.4,.6,.8), na.rm=T)
  }
}
q5 <- function(variable) {as.factor(ntile(variable, 5))}
# Palette
palette5 <- c("#b3cde0","#6497b1","#005b96","#03396c","#011f4b")





#ACS DATA


# Input API key
census_api_key("d9ebfd04caa0138647fbacd94c657cdecbf705e9", install = TRUE, overwrite = TRUE)

# Variables: Median Rent, Median HH Income, Population, Bachelor's, No Vehicle (home owner, renter), Households (owner, renter-occupied)
# Projection: (NAD 1983 StatePlane Massachusetts Mainland FIPS 2001 Feet)
#2010
oritracts10 <-  
  get_acs(geography = "tract", variables = c("B25058_001E", "B19013_001E", "B01003_001E", "B06009_005E", 
                                             "B25044_003E", "B25044_010E", "B07013_002E", "B07013_003E"), 
          year=2010, state=25, county=025, geometry=T) %>% 
  st_transform('ESRI:102686')
#2018
oritracts18 <-  
  get_acs(geography = "tract", variables = c("B25058_001E", "B19013_001E", "B01003_001E", "B06009_005E", 
                                             "B25044_003E", "B25044_010E", "B07013_002E", "B07013_003E"), 
          year=2018, state=25, county=025, geometry=T) %>% 
  st_transform('ESRI:102686')

##############################Long form to wide form###############################
#2010
tracts10 <- 
  oritracts10 %>%
  dplyr::select( -NAME, -moe) %>%
  spread(variable, estimate) %>%
  dplyr::select(-geometry) %>%
  rename(Rent = B25058_001, 
         medHHInc = B19013_001,
         population = B01003_001, 
         bachelor = B06009_005,
         noVehicle_hmow = B25044_003, 
         noVehicle_hmre = B25044_010,
         Households_hmow = B07013_002,
         Households_hmre = B07013_003)
st_drop_geometry(tracts10)[1:3,]
#2018
tracts18 <- 
  oritracts18 %>%
  dplyr::select( -NAME, -moe) %>%
  spread(variable, estimate) %>%
  dplyr::select(-geometry) %>%
  rename(Rent = B25058_001, 
         medHHInc = B19013_001,
         population = B01003_001, 
         bachelor = B06009_005,
         noVehicle_hmow = B25044_003, 
         noVehicle_hmre  = B25044_010,
         Households_hmow = B07013_002,
         Households_hmre = B07013_003)
st_drop_geometry(tracts18)[1:3,]

###################################Mutate##########################################
#2010
tracts10 <- 
  tracts10 %>%
  mutate(pctBach = ifelse(population > 0, bachelor / population, 0),
         pctNoVehicle = ifelse(Households_hmow + Households_hmre > 0, 
                               (noVehicle_hmow + noVehicle_hmre) / 
                                  (Households_hmow + Households_hmre),0),
         year = "2010") %>%
  dplyr::select(-Households_hmow,-Households_hmre,-noVehicle_hmow,-noVehicle_hmre,-bachelor)
#2018
tracts18 <- 
  tracts18 %>%
  mutate(pctBach = ifelse(population > 0, bachelor / population, 0),
         pctNoVehicle = ifelse(Households_hmow + Households_hmre > 0, 
                               (noVehicle_hmow + noVehicle_hmre) / 
                                 (Households_hmow + Households_hmre),0),
         year = "2018") %>%
  dplyr::select(-Households_hmow,-Households_hmre,-noVehicle_hmow,-noVehicle_hmre,-bachelor)

###################################Bind 2010 and 2018#############################
allTracts <- rbind(tracts10,tracts18)

##################################Remove non-Boston tracts######################
bosTracts <- c("25025010405", "25025010404", "25025010801", "25025010702", "25025010204", 
"25025010802", "25025010104", "25025000703", "25025000504", "25025000704", "25025010103", 
"25025000803", "25025980300", "25025120201", "25025120104", "25025110607", "25025000302", 
"25025000301", "25025140400", "25025140300", "25025140201", "25025140202", "25025140102", 
"25025130402", "25025130300", "25025130200", "25025130100", "25025120700", "25025120600", 
"25025120500", "25025120400", "25025110601", "25025110502", "25025110501", "25025110401", 
"25025101102", "25025101101", "25025101002", "25025101001", "25025100900", "25025100800", 
"25025100601", "25025100500", "25025100400", "25025100300", "25025981300", "25025981201", 
"25025990101", "25025981501", "25025981700", "25025981800", "25025100200", "25025100100", 
"25025092400", "25025092300", "25025092200", "25025092000", "25025091900", "25025091800", 
"25025091700", "25025091600", "25025981100", "25025140105", "25025980700", "25025120105", 
"25025120301", "25025071201", "25025091001", "25025091500", "25025091400", "25025091300", 
"25025091200", "25025091100", "25025090700", "25025090600", "25025090400", "25025090300", 
"25025090200", "25025980101", "25025040801", "25025010203", "25025110403", "25025110201", 
"25025981000", "25025090100", "25025082100", "25025082000", "25025081900", "25025081800", 
"25025081700", "25025081500", "25025081400", "25025081300", "25025110103", "25025110301", 
"25025140106", "25025010701", "25025010408", "25025000503", "25025081200", "25025081100", 
"25025080900", "25025080801", "25025080601", "25025080500", "25025080401", "25025080300", 
"25025071101", "25025070900", "25025140107", "25025130404", "25025130406", "25025120103", 
"25025100700", "25025100603", "25025092101", "25025061101", "25025070800", "25025070700", 
"25025070600", "25025070500", "25025070300", "25025070200", "25025070101", "25025061200", 
"25025061000", "25025060800", "25025060700", "25025080100", "25025060301", "25025090901", 
"25025060101", "25025981502", "25025060600", "25025060400", "25025060200", "25025051200", 
"25025050700", "25025050600", "25025050500", "25025050400", "25025050300", "25025050200", 
"25025040300", "25025040200", "25025030500", "25025981600", "25025051101", "25025051000", 
"25025030400", "25025030300", "25025030200", "25025030100", "25025020200", "25025010600", 
"25025010500", "25025010300", "25025000802", "25025000701", "25025050101", "25025050901", 
"25025060501", "25025981202", "25025040100", "25025040600", "25025000602", "25025000601", 
"25025000502", "25025000402", "25025000401", "25025000202", "25025000201", "25025040401", 
"25025020303", "25025070402", "25025020302", "25025020301", "25025020101", "25025081001", 
"25025010403", "25025000100")

allTractsBos <- 
  subset(allTracts, GEOID %in% bosTracts)

#################################Transit Data####################################
mbtaNode <- st_read("/Users/annaduan/Documents/GitHub/TOD-Assignment/mbta_node.geojson") %>% st_transform(st_crs(allTractsBos)) 

#######################Exclude MBTA stops outside Boston#######################
#Filter out non-Boston stations
bosStations <-
  mbtaNode %>%
  filter(station != "Alewife" & station != "Assembly" & station != "Beachmont" & station !=  "Beaconsfield" & station !=  "Bellingham Square" & station !=  "Box District" & station !=  
         "Braintree" & station !=  "Brandon Hall" & station !=  "Brookline Village" & station !=  "Brookline Hills" & station !=  "Capen Street" & station !=  "Central" & station !=  
         "Central Avenue" & station !=  "Chelsea" & station !=  "Chestnut Hill" & station !=  "Coolidge Corner" & station !=  "Davis" & station !=  "Dean Road" & station !=  "Eastern Avenue" & station !=  
         "Eliot" & station !=  "Englewood Avenue" & station !=  "Fairbanks Street" & station !=  "Harvard" & station !=  "Hawes Street" & station !=  "Kendall/MIT" & station !=  "Kent Street" & station !=  "Longwood" & station !=  
         "Malden Center" & station !=  "Milton" & station !=  "Newton Centre" & station !=  "Newton Highlands" & station !=  "North Quincy" & station !=  "Oak Grove" & station !=  "Porter" & station !=  
         "Quincy Adams" & station !=  "Quincy Center" & station !=  "Revere Beach" & station !=  "Riverside" & station !=  "Saint Marys Street" & station !=  "Saint Paul Street" & station !=  
         "Summit Avenue" & station !=  "Tappan Street" & station !=  "Valley Road" & station !=  "Waban" & station !=  "Washington Square" & station !=  "Wellington" & station !=  "Wollaston" & station !=  
         "Wonderland" & station !=  "Woodland" & station !=  "Bellingham Sq"  & station !=  "Eastern Ave"  & station !=  "Brandon Hall" & station != "Summit Ave/Winchester St" & station != "Lechmere")

####################################Set TOD buffer##################################
bosBuffers <- 
  rbind(
    st_buffer(bosStations, 2640) %>% #in feet
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend),
    st_union(st_buffer(bosStations, 2640)) %>% #union buffer
      st_sf() %>%
      mutate(Legend = "Unioned Buffer"))

#############################Select by Centroids################################
buffer <- filter(bosBuffers, Legend=="Unioned Buffer")

selectCentroids <-
  st_centroid(allTractsBos)[buffer,] %>%
    st_drop_geometry() %>%
    left_join(dplyr::select(allTractsBos, GEOID)) %>%
    st_sf() %>%
    dplyr::select(year, population, Rent) %>%
    mutate(Selection_Type = "Select by Centroids")
#2010
selectCentroids10 <-
  st_centroid(tracts10)[buffer,] %>%
    st_drop_geometry() %>%
    left_join(dplyr::select(tracts10, GEOID)) %>%
    st_sf() %>%
    dplyr::select(year, population, Rent) %>%
    mutate(Selection_Type = "Select by Centroids")
#2018
selectCentroids18 <-
  st_centroid(tracts18)[buffer,] %>%
  st_drop_geometry() %>%
  left_join(dplyr::select(tracts18, GEOID)) %>%
  st_sf() %>%
  dplyr::select(year, population, Rent) %>%
  mutate(Selection_Type = "Select by Centroids")

###########################INDICATOR MAPS#######################################
#$100 in 2010 is equivalent in purchasing power to about $115.21 in 2018
#Select tracts within and outside of 0.5mile buffer
allTracts.group <- 
  rbind(
    st_centroid(allTractsBos)[buffer,] %>%
      st_drop_geometry() %>%
      left_join(allTractsBos) %>%
      st_sf() %>%
      mutate(TOD = "TOD"),
    st_centroid(allTractsBos)[buffer, op = st_disjoint] %>%
      st_drop_geometry() %>%
      left_join(allTractsBos) %>%
      st_sf() %>%
      mutate(TOD = "Non-TOD")) %>%
  mutate(Rent.inf = ifelse(year == "2010", Rent * 1.1521, Rent))
```

## 1. Does TOD attract growth in population and rent?
If the hypothesis that transit-rich neighborhoods are desirable, it is then expected that neighborhoods close to a transit station should experience growth in population and rent as more people are drawn to them and willing to pay a premium to live near transit. The maps below document changes in rent and population in TOD tracts (within 0.5 miles of a transit station) between 2010 and 2018. In figure 1.1, we see substantial population growth in census tracts in the downtown area, near the intersections of the subway lines. Similarly, in figure 1.2, there are increases in rent citywide, with the most marked change occurring in the downtown area. Based on this, it appears that over time TOD neighborhoods in Boston are growing in population and experiencing increases in land value.

```{r Graduated Symbol Maps, fig.height=5, fig.width=8, message=FALSE, warning=FALSE, include=TRUE}
centectroi10_pop <- st_centroid(selectCentroids10[,1])
centectroi18_pop <- st_centroid(selectCentroids18[,1])
troi_pop <- rbind(selectCentroids10[,1:2], selectCentroids18[,1:2]) 
oitroi_pop.group <- st_centroid(troi_pop)
centectroi10_re <- st_centroid(selectCentroids10[,2])
centectroi18_re <- st_centroid(selectCentroids18[,2])
troi_rent <- rbind(selectCentroids10[,c(1,3)], selectCentroids18[,c(1,3)]) 
oitroi_rent.group <- st_centroid(troi_rent)
#population
ggplot() + 
  geom_sf(data=st_union(allTracts.group)) +
  geom_sf(data = buffer, fill = "white") + 
  geom_sf(data = oitroi_pop.group, aes(size = population), shape = 21, 
      fill = "lightblue", alpha = 0.8, show.legend = "point") + 
  scale_size_continuous(range = c(0.05, 4))+
  facet_wrap(~year)+
  labs(title = "Population 2010-2018", subtitle = "Boston, MA", caption="Figure 1.1") +
  mapTheme() + 
  theme(plot.title = element_text(size=22))
#rent
ggplot() + 
  geom_sf(data=st_union(allTractsBos)) +
  geom_sf(data = buffer, fill = "white") + 
  geom_sf(data = oitroi_rent.group, aes(size = Rent), shape = 21, color = "transparent",
          fill = "pink", alpha = 1, show.legend = "point") + 
  scale_size_continuous(range = c(0.05, 4))+
  facet_wrap(~year)+
  labs(title = "Rent 2010-2018", subtitle = "Boston, MA", caption="Figure 1.2") +
  mapTheme() + 
  theme(plot.title = element_text(size=22))
```

## 2. How does TOD affect other neighborhood characteristics?
Now that we know TOD neighborhoods in Boston grew in population between 2010 and 2018, the next step is to compare TOD neighborhoods to non-TOD neighborhoods. In this section, we have also added additional neighborhood characteristics to our analysis: pctBach is the share of adults with Bachelor's degrees, MedHHInc is median household income, and pctNoVehicle is the share of households which don't own a private vehicle. Neighborhoods which are desirable should experience growth in both pctBach and MedHHInc over time. Neighborhoods which experience pctNoVehicle growth may be more amenable to walking or using public transit. 

### Population
Citywide, TOD areas have some of the most populated census tracts, although some non-TOD tracts in the South have populations in the highest quintile. In terms of growth, however, the greatest population growth appears to occur within TOD areas, in the downtown region. While this supports the idea that TOD neighborhoods attract growth, the extent to which TOD influenced this growth is unclear because the downtown area may also be attractive for a range of other reasons including business, recreation, and culture.
```{r Population, fig.height=5, fig.width=8, message=FALSE, warning=FALSE, include=TRUE}
ggplot(allTracts.group)+
  geom_sf(data = st_union(allTractsBos))+
  geom_sf(aes(fill = q5(population))) +
  geom_sf(data = buffer, fill = "transparent", color = "red")+
  scale_fill_manual(values = palette5,
                    labels = qBr(allTracts.group, "population"),
                    name = "Population\n(Quintile Breaks, TOD in Red)") +
  labs(title = "Total Population 2010 - 2018", subtitle = "Boston, MA", caption="Figure 2.1") +
  facet_wrap(~year)+
  mapTheme() + 
  theme(plot.title = element_text(size=22))
```

### Bachelor's Degrees
The share of adults holding Bachelor's Degrees is highest in the TOD tracts, with a few exceptions in the South. With regards to growth, neither TOD and non-TOD tracts improve very significantly between 2010 and 2018. This result suggests that tracts with TOD are likely to have more educated residents, although it is unclear whether the presence of TOD is what attracts them.
```{r Bachelors Degrees, fig.height=5, fig.width=8, message=FALSE, warning=FALSE, include=TRUE}
ggplot(allTracts.group)+
  geom_sf(data = st_union(allTractsBos))+
  geom_sf(aes(fill = q5(pctBach))) +
  geom_sf(data = buffer, fill = "transparent", color = "red")+
  scale_fill_manual(values = palette5,
                    labels = qBr(allTracts.group %>% mutate(pctBach_100 = pctBach *100), "pctBach_100"),
                    name = "% >25 Years with Bachelor's\n(Quintile Breaks, TOD in Red)") +
  labs(title = "Share of Adults with Bachelor's Degree 2010 - 2018", subtitle = "Boston, MA", caption="Figure 2.2") +
  facet_wrap(~year)+
  mapTheme() + 
  theme(plot.title = element_text(size=22))
```

### Median Household Income
Figure 2.3 shows that in 2010, the neighborhoods with the highest median incomes were non-TOD. However, in 2018, numerous tracts within the TOD area have transitioned to the highest median income category. This growth could mean that TOD areas attract wealthier households, although this growth could also be the result of the multiplier effect brought by downtown development as most of the TOD tracts which experienced growth are within the downtown area.
```{r Median Household Income, fig.height=5, fig.width=8, message=FALSE, warning=FALSE, include=TRUE}
ggplot(allTracts.group)+
  geom_sf(data = st_union(allTractsBos))+
  geom_sf(aes(fill = q5(medHHInc))) +
  geom_sf(data = buffer, fill = "transparent", color = "red")+
  scale_fill_manual(values = palette5,
                    labels = qBr(allTracts.group, "medHHInc"),
                    name = "Median HH Income\n(Quintile Breaks, TOD in Red)") +
  labs(title = "Median Household Income 2010 - 2018", subtitle = "Boston, MA (US Dollars)", caption="Figure 2.3") +
  facet_wrap(~year)+
  mapTheme() + 
  theme(plot.title = element_text(size=22))
```

### Households without Vehicles
Finally, map 2.4 shows a significant difference in vehicle ownership in TOD and non-TOD neighborhoods Almost all of the TOD tracts are in the highest category of pctNoVehicle, whereas most of the non-TOD tracts have lower shares. This suggests that TOD neighborhoods are indeed more attractive to households that don't own cars due to their walkability and transit access.
```{r Households without Vehicles, fig.height=5, fig.width=8, message=FALSE, warning=FALSE, include=TRUE}
ggplot(allTracts.group)+
  geom_sf(data = st_union(allTractsBos))+
  geom_sf(aes(fill = q5(pctNoVehicle))) +
  geom_sf(data = buffer, fill = "transparent", color = "red")+
  scale_fill_manual(values = palette5,
                    labels = qBr(allTracts.group %>% mutate(pctNoVehicle_100 = pctNoVehicle *100), "pctNoVehicle_100"),
                    name = "% Households\n(Quintile Breaks, TOD in Red)") +
  labs(title = "Share of Households without Vehicle 2010 - 2018", subtitle = "Boston, MA", caption="Figure 2.4") +
  facet_wrap(~year)+
  mapTheme() + 
  theme(plot.title = element_text(size=22))
```

Below, the previous trends are summarized in table 2.1 and 2.2. In 2.2, the data is presented in long form.
```{r Neighborhood Characteristics Tables, message=FALSE, warning=FALSE, include=TRUE}
#Summarize allTracts.group
allTracts.Summary <- 
  st_drop_geometry(allTracts.group) %>%
  group_by(year, TOD) %>%
  summarize(Rent = mean(Rent, na.rm = T),
            Population = mean(population, na.rm = T),
            pctBach = mean(pctBach, na.rm = T),
            pctNoVehicle = mean(pctNoVehicle, na.rm = T),
            MedHHInc = mean(medHHInc, na.rm = T))

kable(allTracts.Summary) %>%
  kable_styling() %>%
  footnote(general_title = "\n",
           general = "Table 2.1")

#Change to Long Form
allTracts.Summary %>%
  unite(year.TOD, year, TOD, sep = ": ", remove = T) %>%
  gather(Variable, Value, -year.TOD) %>%
  mutate(Value = round(Value, 2)) %>%
  spread(year.TOD, Value) %>%
  kable() %>%
  kable_styling() %>%
  footnote(general_title = "\n",
           general = "Table 2.2")
```

For a clearer visual comparison of these trends, let us plot them in a group bar plot. First, we see that other than pctNoVehicle, all  variables have increased citywide. In TOD neighborhoods, as noted earlier, residents are more educated, pay higher rent, and have slightly higher income in 2018. Population is lower in TOD neighborhoods in 2018, and these neighborhoods see less population growth on average than non-TOD areas, contradicting the hypothesis that transit-rich neighborhoods see the most population growth. However, the higher education attainment, income, and rent in these tracts indicate that they are attractive and that people will pay a premium for them. Most notable is the difference in pctNoVehicle in TOD and non-TOD neighborhoods. While it is decreasing citywide, TOD tracts still have more than 10% more households without vehicles, confirming that their transit options make it viable to not own a car.
```{r Neighborhood Characteristics Group Bar Plot, message=FALSE, warning=FALSE, include=TRUE}

###########################TOD Indicator Plots##################################
allTracts.Summary %>%
  gather(Variable, Value, -year, -TOD) %>%
  ggplot(aes(year, Value, fill = TOD)) +
    geom_bar(stat = "identity", position = "dodge") +
    facet_wrap(~Variable, scales = "free", ncol=5) +
    scale_fill_manual(values = c("#bae4bc", "#0868ac")) +
    labs(title = "Indicator differences across time and space", caption="Figure 2.5") +
    plotTheme() + theme(legend.position="bottom")
```

## 3. How does Rent Vary with Distance from Transit?
To further analyze the relationship between TOD and neighborhood desirability, we will look at the relationship between rent and distance from subway stations. This method allows us to look at the relationship between transit and housing without cutting off census tracts outside of the 0.5 mile buffer. 
  In both 2010 and 2018, the highest rent is at the shortest distance from transit stations, within 0.5miles, and it drops until 1 mile from stations. After this, however, both plots display two rent price peaks at roughly 1.5 and 3.2 miles. This aligns with the previous maps and group plots, suggesting that while transit rich neighborhoods have the highest rent prices due to their desirability, transit is not the dominant factor influencing rent prices, particularly outside of the 0.5 mile TOD buffer.

```{r Distance from Transit vs Rent Geom_line Plot, message=FALSE, warning=FALSE, include=TRUE}
multiBuffers <- multipleRingBuffer(bosStations, 4, 0.4) %>% st_sf()
# 2010
rent_dis10 <- data.frame(
  distance = double(),
  Mean_Rent = double(),
  stringsAsFactors=FALSE
)

for (i in seq(0.4,4, by = 0.4)){
  
  A <- st_union(st_buffer(bosStations, i*5280)) %>% st_sf()
  a <- st_union(st_buffer(bosStations, (i-0.4)*5280)) %>% st_sf()
  std <- st_difference(A, a)
  b <-
    st_centroid(tracts10)[std,] %>%
    st_drop_geometry() %>%
    left_join(dplyr::select(tracts10, GEOID)) %>%
    st_sf() %>%
    dplyr::select(Rent)
  b$Rent <- as.numeric(b$Rent)
  c <- mean(b[["Rent"]],na.rm=TRUE)
  d <- data.frame(distance=i, Mean_Rent=c, stringsAsFactors=FALSE)
  rent_dis10 <- rbind(rent_dis10, d)
#  rent_dis10 %>% add_row(distance = i, Mean_Rent = c)
  i <- i + 0.4
}

# for 2018
rent_dis18 <- data.frame(
  distance = double(),
  Mean_Rent = double(),
  stringsAsFactors=FALSE
)

for (i in seq(0.4,4, by = 0.4)){
  
  A <- st_union(st_buffer(bosStations, i*5280)) %>% st_sf()
  a <- st_union(st_buffer(bosStations, (i-0.4)*5280)) %>% st_sf()
  std <- st_difference(A, a)
  b <-
    st_centroid(tracts18)[std,] %>%
    st_drop_geometry() %>%
    left_join(dplyr::select(tracts18, GEOID)) %>%
    st_sf() %>%
    dplyr::select(Rent)
  b$Rent <- as.numeric(b$Rent)
  c <- mean(b[["Rent"]],na.rm=TRUE)
  d <- data.frame(distance=i, Mean_Rent=c, stringsAsFactors=FALSE)
  rent_dis18 <- rbind(rent_dis18, d)
  #  rent_dis10 %>% add_row(distance = i, Mean_Rent = c)
  i <- i + 0.4
}

#2010
ggplot(rent_dis10, aes(x=distance, y=Mean_Rent)) +
  geom_line(arrow = arrow())+
  geom_point()+
  labs(title = "Rent and Distance from Transit 2010", caption="Figure 3.1", subtitle="Boston, MA (in US Dollars and Miles)") +
  scale_color_brewer(palette="Paired")+theme_minimal()
  
#2018
ggplot(rent_dis18, aes(x=distance, y=Mean_Rent)) +
  geom_line(arrow = arrow())+
  geom_point()+
  labs(title = "Rent and Distance from Transit 2010", caption="Figure 3.2", subtitle="Boston, MA (in US Dollars and Miles)") +
  scale_color_brewer(palette="Paired")+theme_minimal()
```

## 4. Are TOD Neighborhoods Safer?
Another proposed benefit of TOD is neighborhood safety. With denser, walkable, and transit-rich neighborhoods, there are more people on the street. This is based in the notion of "eyes on the street," an idea termed by the great urbanist Jane Jacobs, which suggests that dense, lively neighborhoods where residents are out on the streets are safer because of the many people who witness the activity in the area. To test this idea, we plot the incidences of a common street crime category, robbery.

At a glance, it appears that TOD tracts experience a higher rate of robberies, disproving the "eyes on the street" idea. However, it is important to consider another factor that may affect crime: rent. Research has suggested that lower rent is associated with higher crime rates. On the map it appears that TOD and non-TOD tracts that have rents in the lower categories have similar amounts of crime. However, it appears that many TOD tracts in the highest rent category do not have incidences of robberies, while most of the high-rent non-TOD tracts have some robberies. However, another confounding factor is that most TOD tracts are in the downtown area, which can often have the highest crime in a city. Overall, TOD tracts in Boston don't appear to be safer than non-TOD tracts due to the complicated factors influencing crime. However, it appears that neighborhoods which have both high rent and TOD experience less crime. 

```{r crime, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, include=TRUE}
crime12 <- read.csv("/Users/annaduan/Documents/GitHub/TOD-Assignment/Crime12.csv", header = TRUE, sep = ",", quote = "\"",
         dec = ".")
crime18 <- read.csv("/Users/annaduan/Documents/GitHub/TOD-Assignment/Crime18.csv", header = TRUE, sep = ",", quote = "\"",
                       dec = ".")

#crime12 <- read.csv("E:/Upenn/CPLN508/TOD-Assignment/Crime12.csv", header = TRUE, sep = ",", quote = "\"",
#                    dec = ".")
#crime18 <- read.csv("E:/Upenn/CPLN508/TOD-Assignment/Crime18.csv", header = TRUE, sep = ",", quote = "\"",
#                    dec = ".")

crime12.sf <- st_as_sf(crime12, coords = c("LON", "LAT"), crs = 4326, agr = "constant") %>% 
  st_transform(st_crs(allTracts.group))
crime18.sf <- st_as_sf(crime18, coords = c("LON", "LAT"), crs = 4326, agr = "constant")  %>% 
  st_transform(st_crs(allTracts.group))

################################Relate Crime to Census Tracts##############################

#2012
#ggplot() +   
  # geom_sf(data=st_union(allTractsBos)) +
#  geom_sf(data=allTracts.group, aes(fill = q5(Rent.inf))) +
 # geom_sf(data=crime12.sf, show.legend = "point", size= 0.4, color = "white") +
  #geom_sf(data = buffer, fill = "transparent", color = "red") +
#  scale_fill_manual(values = palette5,
#                    labels = qBr(allTracts.group, "Rent.inf"),
 #                   name = "Rent\n(Quintile Breaks)") +
#  facet_wrap(~TOD) +
#  labs(title="Crime, Transit Access, and Rent, 2012", subtitle="Boston, MA", caption="Figure 7.2") +
#  mapTheme()

#2018
#ggplot() +   
 # geom_sf(data=st_union(allTractsBos)) +
 # scale_fill_manual(values = palette5,
 #                   labels = qBr(allTracts.group, "Rent.inf"),
  #                  name = "Rent\n(Quintile Breaks)") +
 # facet_wrap(~TOD) +
 # mapTheme() +
  #geom_sf(data=allTracts.group, aes(fill = q5(Rent.inf))) +
 # geom_sf(data=crime18.sf, show.legend = "point", size= 0.4, color = "white") +
#  labs(title="Crime, Transit Access, and Rent, 2018", subtitle="Boston, MA", caption="Figure 7.1") +
#  geom_sf(data = buffer, fill = "transparent", color = "red") +
#  mapTheme()


crime.sf <- rbind(crime12.sf, crime18.sf)

ggplot() +   
#  geom_sf(data=st_union(allTractsBos)) +
 scale_fill_manual(values = palette5,
                    labels = qBr(allTracts.group, "Rent.inf"),
                    name = "Rent\n(Quintile Breaks)") +
  geom_sf(data=allTracts.group, aes(fill = q5(Rent.inf))) +
  geom_sf(data=crime.sf, show.legend = "point", size= 0.1, color = "white") +
  labs(title="Crime, Transit Access, and Rent, 2012 & 2018", subtitle="Boston, MA", caption="Figure 2.5") +
  facet_wrap(~TOD) +
  mapTheme() 
```

